The intent here is to not simply build tables; we build a governed ecosystem. Based on the Project Bible, I recommend a **Hybrid Medallion-Star Architecture**. We will use normalized structures in the Silver (Cleansed) layer for integrity and Star Schemas in the Gold (Analytics) layer for performance and BI consumption.

Below is the detailed Data Model Design.

---

### 1. Database & Schema Strategy
To enforce separation of duties and security, we will not place all objects in one schema. We will use a multi-schema database approach within the `PATIENT_ACCESS_DB`.

*   `RAW_LANDING`: Ingestion layer (CDC mirrors, semi-structured VARIANT columns).
*   `CORE_DW`: The Enterprise Data Warehouse (Normalized 3NF, SCD Type 2 Dimensions, Conformed Facts).
*   `ANALYTICS_MART`: Star Schema optimized for BI/ML (Denormalized, Aggregated).
*   `SECURE_VAULT`: Restricted schema for PII/PHI (Access controlled via Dynamic Data Masking).

---

### 2. Dimensional Modeling Strategy (Gold/Analytics Layer)
For the consumption layer, we will implement a **Star Schema**. This ensures that PowerBI/Tableau and Snowpark ML models query efficiently without complex joins.

#### 2.1. Conformed Dimensions
*Design Note: All dimensions use Surrogate Keys (`DIM_ID`) generated by Snowflake Sequences to handle Slowly Changing Dimensions (SCD Type 2). We track `START_DATE`, `END_DATE`, and `IS_CURRENT`.*

**A. DIM_DATE (Time)**
*Critical for call center interval reporting (e.g., 30-min buckets).*
```sql
CREATE OR REPLACE TABLE ANALYTICS_MART.DIM_DATE (
    DATE_KEY NUMBER(8,0) PRIMARY KEY, -- YYYYMMDD
    FULL_DATE DATE,
    DAY_OF_WEEK NUMBER(2,0),
    DAY_NAME VARCHAR(9),
    IS_WEEKEND BOOLEAN,
    IS_HOLIDAY BOOLEAN,
    FISCAL_YEAR NUMBER(4,0),
    FISCAL_QUARTER NUMBER(2,0),
    CALL_CENTER_INTERVAL_ID VARCHAR(50) -- e.g., '20231027_0930' for 30-min bucketing
);
```

**B. DIM_AGENT (Staffing)**
*SCD Type 2 is mandatory here. Agents change teams, roles, and skill groups frequently.*
```sql
CREATE OR REPLACE TABLE ANALYTICS_MART.DIM_AGENT (
    AGENT_DIM_KEY NUMBER(38,0) PRIMARY KEY,
    AGENT_BIZ_KEY VARCHAR(50) NOT NULL, -- Unique ID from HR/Telephony
    AGENT_NAME_HASH VARCHAR(64), -- Hashed name for privacy if needed
    TEAM_NAME VARCHAR(100),
    DEPARTMENT_NAME VARCHAR(100),
    ROLE_TITLE VARCHAR(100),
    HIRE_DATE DATE,
    TERM_DATE DATE,
    IS_ACTIVE BOOLEAN,
    START_TS TIMESTAMP_NTZ(9),
    END_TS TIMESTAMP_NTZ(9),
    IS_CURRENT BOOLEAN DEFAULT TRUE
);
```

**C. DIM_PATIENT (Access)**
*Security Note: Do not store Name/DOB/SSN here. Store the MRN (Medical Record Number) and a Tokenized ID. PII resides in `SECURE_VAULT`.*
```sql
CREATE OR REPLACE TABLE ANALYTICS_MART.DIM_PATIENT (
    PATIENT_DIM_KEY NUMBER(38,0) PRIMARY KEY,
    PATIENT_MRN_HASH VARCHAR(64) NOT NULL, -- Hashed MRN for joining
    PATIENT_TOKEN_ID VARCHAR(100), -- Re-identifiable token if authorized
    AGE_BAND VARCHAR(20), -- Derived, e.g., '18-25', '65+' to avoid direct DOB exposure
    GENDER_CODE VARCHAR(10),
    PAYOR_CLASS VARCHAR(50), -- Commercial, Medicare, Medicaid
    RISK_SCORE_CATEGORY VARCHAR(20), -- For ML segmentation
    START_TS TIMESTAMP_NTZ(9),
    END_TS TIMESTAMP_NTZ(9),
    IS_CURRENT BOOLEAN DEFAULT TRUE
);
```

**D. DIM_PROVIDER & DIM_CLINIC**
*Links appointments to physical locations and clinicians.*
```sql
CREATE OR REPLACE TABLE ANALYTICS_MART.DIM_CLINIC (
    CLINIC_DIM_KEY NUMBER(38,0) PRIMARY KEY,
    CLINIC_BIZ_KEY VARCHAR(50),
    CLINIC_NAME VARCHAR(150),
    REGION VARCHAR(50),
    TIMEZONE_NAME VARCHAR(50), -- Critical for call timestamp normalization
    IS_VIRTUAL BOOLEAN,
    IS_CURRENT BOOLEAN DEFAULT TRUE
);
```

**E. DIM_CALL_DISPOSITION**
*Standardizes reason codes across different telephony vendors.*
```sql
CREATE OR REPLACE TABLE ANALYTICS_MART.DIM_CALL_DISPOSITION (
    DISPOSITION_DIM_KEY NUMBER(38,0) PRIMARY KEY,
    SOURCE_SYSTEM VARCHAR(50),
    RAW_CODE VARCHAR(50),
    STANDARDIZED_CATEGORY VARCHAR(100), -- e.g., 'Scheduling', 'Billing', 'Clinical'
    IS_TRANSFER_REQUIRED BOOLEAN
);
```

---

### 3. Fact Tables (The Metrics)
*Design Note: Facts store foreign keys to Dimensions and additive measures. We use `TIMESTAMP_NTZ` for storage to save space and normalize to UTC, converting to local time at query time using `DIM_CLINIC.TIMEZONE_NAME`.*

**A. FACT_CALL_INTERACTION (Grain: One Row Per Call Session)**
*Supports: Call Volume, AHT, Abandonment, Service Level.*
```sql
CREATE OR REPLACE TABLE ANALYTICS_MART.FACT_CALL_INTERACTION (
    CALL_FACT_KEY NUMBER(38,0) PRIMARY KEY,
    CALL_BIZ_KEY VARCHAR(100) NOT NULL, -- Unique Call ID from Telephony
    DATE_KEY NUMBER(8,0), -- FK to DIM_DATE
    AGENT_DIM_KEY NUMBER(38,0), -- FK (Null if IVR/Abandoned)
    PATIENT_DIM_KEY NUMBER(38,0), -- FK (Null if anonymous)
    DISPOSITION_DIM_KEY NUMBER(38,0), -- FK
    
    -- Timestamps (UTC)
    CALL_START_TS TIMESTAMP_NTZ(9),
    CALL_END_TS TIMESTAMP_NTZ(9),
    ANSWER_TS TIMESTAMP_NTZ(9),
    
    -- Measures (Seconds)
    QUEUE_WAIT_DURATION_SEC NUMBER(10,2),
    TALK_DURATION_SEC NUMBER(10,2),
    HOLD_DURATION_SEC NUMBER(10,2),
    AFTER_CALL_WORK_SEC NUMBER(10,2),
    
    -- Flags
    IS_ABANDONED BOOLEAN,
    IS_FIRST_CALL_RESOLUTION BOOLEAN,
    IS_TRANSFERRED BOOLEAN,
    
    -- Audit
    LOAD_TS TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
    SOURCE_BATCH_ID VARCHAR(50)
) CLUSTER BY (DATE_KEY, CALL_START_TS);
```
*Optimization:* Clustering by `DATE_KEY` and `CALL_START_TS` ensures that time-range queries (e.g., "Last 7 Days") prune micro-partitions efficiently.

**B. FACT_APPOINTMENT_LIFECYCLE (Grain: One Row Per Appointment Instance)**
*Supports: No-Show Rates, Slot Utilization, Time-to-Appointment.*
```sql
CREATE OR REPLACE TABLE ANALYTICS_MART.FACT_APPOINTMENT_LIFECYCLE (
    APPT_FACT_KEY NUMBER(38,0) PRIMARY KEY,
    APPT_BIZ_KEY VARCHAR(100) NOT NULL,
    DATE_KEY NUMBER(8,0), -- Appointment Date
    BOOKING_DATE_KEY NUMBER(8,0), -- Date Appointment was Made
    
    PATIENT_DIM_KEY NUMBER(38,0),
    PROVIDER_DIM_KEY NUMBER(38,0),
    CLINIC_DIM_KEY NUMBER(38,0),
    AGENT_DIM_KEY NUMBER(38,0), -- Agent who booked it
    
    -- Scheduling Metrics
    LEAD_TIME_DAYS NUMBER(10,2), -- Appt Date - Booking Date
    SLOT_DURATION_MIN NUMBER(10,2),
    
    -- Status
    APPOINTMENT_STATUS_CODE VARCHAR(20), -- Completed, No-Show, Cancelled, Rescheduled
    CANCELLATION_REASON_CODE VARCHAR(50),
    NO_SHOW_PREDICTION_SCORE FLOAT, -- Output from ML Model
    
    -- Audit
    LOAD_TS TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
) CLUSTER BY (DATE_KEY, CLINIC_DIM_KEY);
```

**C. FACT_AGENT_STATE (Grain: One Row Per Status Change)**
*Supports: Occupancy, Adherence, Shrinkage Analysis.*
```sql
CREATE OR REPLACE TABLE ANALYTICS_MART.FACT_AGENT_STATE (
    STATE_FACT_KEY NUMBER(38,0) PRIMARY KEY,
    AGENT_DIM_KEY NUMBER(38,0),
    DATE_KEY NUMBER(8,0),
    
    STATE_START_TS TIMESTAMP_NTZ(9),
    STATE_END_TS TIMESTAMP_NTZ(9),
    DURATION_SEC NUMBER(10,2),
    
    STATE_CODE VARCHAR(50), -- Available, Busy, Break, Lunch, Training
    IS_PRODUCING_STATE BOOLEAN -- True if Available or Busy (for Occupancy calc)
) CLUSTER BY (AGENT_DIM_KEY, STATE_START_TS);
```

---

### 4. Snowflake-Specific Implementation Details

#### 4.1. Security & PHI Governance (RBAC + Masking)
In Pharma/Healthcare, we cannot rely solely on application security. The data model must enforce it.

*   **Column-Level Security:** We will apply Masking Policies to the `SECURE_VAULT` tables and any PII columns in `CORE_DW`.
    ```sql
    CREATE MASKING POLICY ANALYTICS_MART.PHI_MASK AS (val STRING) RETURNS STRING ->
      CASE 
        WHEN CURRENT_ROLE() IN ('ROLE_SECURITY_ADMIN', 'ROLE_CLINICAL_LEAD') THEN val
        ELSE '***REDACTED***'
      END;
    ```
*   **Row-Level Security:** Use Secure Views for specific regions.
    ```sql
    CREATE SECURE VIEW ANALYTICS_MART.VW_CALL_CENTER_EAST AS
    SELECT * FROM ANALYTICS_MART.FACT_CALL_INTERACTION f
    JOIN ANALYTICS_MART.DIM_CLINIC c ON f.CLINIC_DIM_KEY = c.CLINIC_DIM_KEY
    WHERE c.REGION = 'EAST';
    ```

#### 4.2. Performance Optimization
*   **Clustering Keys:** As shown in the DDL, time-series data (Calls, Agent State) must be clustered on timestamps to minimize credit consumption during range scans.
*   **Search Optimization Service:** For high-cardinality lookups (e.g., finding a specific `PATIENT_MRN_HASH`), enable Search Optimization on the `DIM_PATIENT` table.
*   **Automatic Clustering:** Monitor `AUTOMATIC_CLUSTERING_HISTORY` to ensure costs don't spiral due to high-churn tables like `FACT_CALL_INTERACTION`.

#### 4.3. Data Quality & Observability
To meet the "Success Criteria" of reliability:
*   **NOT NULL Constraints:** Enforced on all Business Keys and Foreign Keys in the Gold layer.
*   **Stream & Task Integration:** We will create `STREAM` objects on the `RAW_LANDING` tables. A `TASK` will orchestrate the movement from Raw -> Core -> Analytics.
*   **Data Quality Table:** A dedicated table `ANALYTICS_MART.DQ_LOG` to store results of automated checks (e.g., "Call Duration cannot be negative", "Appointment Date cannot be in the past for Completed status").

#### 4.4. Machine Learning Readiness
The Project Bible specifies ML for No-Show Prediction and Staffing.
*   **Feature Store:** The `FACT_APPOINTMENT_LIFECYCLE` table includes `NO_SHOW_PREDICTION_SCORE`. We will create a separate table `ANALYTICS_MART.ML_FEATURE_STORE` that aggregates historical patient behavior (e.g., `COUNT_NO_SHOWS_LAST_12MO`) to feed Snowpark ML models.
*   **Write-Back:** Predictions generated by Snowpark Python UDFs will be written back to the `FACT_APPOINTMENT_LIFECYCLE` table, allowing BI dashboards to visualize "Risk" alongside actuals.

---

### 5. Implementation Roadmap (SQL Developer Perspective)

1.  **Phase 1: Foundation:** Deploy `DIM_DATE`, `DIM_CLINIC`, `DIM_AGENT`. Establish RBAC roles (`ROLE_ANALYTICS_READ`, `ROLE_DATA_ENGINEER_WRITE`).
2.  **Phase 2: Ingestion Pipelines:** Build CDC streams from Telephony and Scheduling sources into `RAW_LANDING`. Implement initial transformation tasks to `CORE_DW`.
3.  **Phase 3: Analytics Mart:** Build the Star Schema Facts. Apply Clustering Keys. Validate metric calculations against legacy reports (Parallel Run).
4.  **Phase 4: Security & Governance:** Apply Masking Policies. Implement Secure Views for stakeholder groups.
5.  **Phase 5: ML Integration:** Deploy the No-Show model via Snowpark. Populate the prediction column in the Fact table.

### 6. Why This Model? (Rationale)
*   **Scalability:** Separating `FACT_CALL_INTERACTION` (high volume) from `DIM_PATIENT` (slowly changing) allows Snowflake to scale compute independently for heavy aggregation queries.
*   **Compliance:** By isolating PII and using Hashed Keys in the main Fact tables, we reduce the scope of HIPAA audits for general analysts.
*   **Flexibility:** The SCD Type 2 design allows us to answer historical questions accurately (e.g., "What was the performance of this Agent *when they were on Team A*, even if they are on Team B now?").
*   **Cost Control:** Clustering and proper data typing (`TIMESTAMP_NTZ` vs `TZ`) reduce storage and compute costs, which is a specific KPI in the Project Bible.

This model provides the robust, governed, and high-performance foundation required to transform Patient Access operations from reactive reporting to predictive optimization.
